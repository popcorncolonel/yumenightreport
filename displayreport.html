{# lists all the relevant things either with a form or in a div, optionally #}
{% if form %}
{% macro entry(type_of_data, name, value=None, class="", type="text") -%}
    {% if report %}
    {% if name in report %}
    {{ type_of_data }}: <input name='{{ name }}' value='{{ report[name] }}' class='{{ class }}' type='{{ type }}'/>
    {% else %}
    {{ type_of_data }}: <input name='{{ name }}' value='{{ value }}' class='{{ class }}' type='{{ type }}'/>
    {% endif %}
    {% elif value == None %}
    {{ type_of_data }}: <input name='{{ name }}' class='{{ class }}' type='{{ type }}'/>
    {% else %}
    {{ type_of_data }}: <input name='{{ name }}' value='{{ value }}' class='{{ class }}' type='{{ type }}'/>
    {% endif %}
{%- endmacro %}
{% else %}
    {# then the `report` variable exists #}
{% macro entry(type_of_data, name, value=None, class="", type="text") -%}
    <strong>{{ type_of_data }}</strong>: <span name='{{ name }}'> {{ report[name] }} </span>
    {% if preview %}
    <input name='{{ name }}' value="{{ report[name] }}" type="hidden"/>
    {% endif %}
{%- endmacro %}
{% endif %}

{% macro hspace() -%}
    <span style="padding-left: 40px;"> &nbsp; </span>
{%- endmacro %}

{% if form %}
<form action="/previewreport" method="GET">
{% elif preview %}
<form action="/createreport" method="POST">
{% endif %}

{% if form %}
<input type="hidden" name="old_date_string" value="{{ report['date_string'] }}"/>
{% elif preview and old_date_string %}
<input type="hidden" name="old_date_string" value="{{ old_date_string }}"/>
{% endif %}

<div class="bluebackground">
<div class="parent fixedwidthreport">
    {% if hidetitleimg %}
    <img class="centerimg titleimg" src="/images/logo.jpg"/>
    {% endif %}
    <h2 class="textcenter"> Nightly Report </h2> 
    {% if form %}
    <div class="textcenter">
    {{ entry('Date (yyyy-mm-dd)', 'date', value=report['date_string']) }}
    </div> 
    {% else %}
    {% if preview %}
    <input type="hidden" name="date" value="{{ report["date"] }}"/>
    {% endif %}
    <div class="textcenter">
    {{ report["readable_date_string"] }}
    </div> 
    {% endif %}

    <hr style="margin-top: 20px; margin-bottom: 20px">

    <div class="textcenter">
    <strong>Yearly goal</strong>: <span name='year_goal'> {{ report['year_goal'] if report['year_goal'] else global_stats.year_goal }} </span>
    {{ hspace() }}
    <strong>Monthly goal</strong>: <span name='month_goal'> {{ report['month_goal'] if report['month_goal'] else global_stats.month_goal }} </span>
    </div> 
    <div class="textcenter">
    <strong>Yearly dream goal</strong>: <span name='yearly_dream_goal'> {{ report['yearly_dream_goal'] if report['yearly_dream_goal'] else global_stats.yearly_dream_goal }} </span>
    {{ hspace() }}
    <strong>Daily dream goal</strong>: <span name='daily_dream_goal'>
    {% if 'daily_dream_goal' in report %}
    {{ report['daily_dream_goal'] }}
    {% elif 'datetime_obj' in report %}
    {{ global_stats.daily_dream_goal(datetime_obj=report['datetime_obj']) }}
    {% else %}
    {{ global_stats.daily_dream_goal() }}
    {% endif %}
    </span>
    </div> 

    <hr style="margin-top: 20px; margin-bottom: 20px">

    <div class="textcenter">
    {{ entry('Customers today', 'customers_today', type="number", class="shorttextbox") }}
    {% if not form %}
    {{ hspace() }}
    {{ entry('Customers this year', 'customers_this_year', class="shorttextbox") }}
    {% endif %}
    </div> 

    <div class="textcenter">
    {{ entry('Number of dreams today', 'dreams', type="number", class="shorttextbox") }}
    {% if not form %}
    {{ hspace() }}
    {{ entry('Number of dreams this year', 'dreams_this_year', class="shorttextbox") }}
    {% endif %}
    </div> 

    <div class="textcenter">
    {{ entry('Number of dreamers today', 'dreamers', type="number", class="shorttextbox") }}
    {% if not form %}
    {{ hspace() }}
    {{ entry('Dream achievement rate', 'achievement_rate', class="shorttextbox") }}
    {% endif %}
    </div> 

    <hr style="margin-top: 20px; margin-bottom: 20px">

    <div class="textcenter">
    {{ entry('Working members', 'working_members', class="longtextbox") }}
    </div> 
    <div class="textcenter">
    {{ entry('Supporting members', 'supporting_members', class="longtextbox") }}
    </div> 
    <div class="textcenter">
    {{ entry('Visiting members', 'visiting_members', class="longtextbox") }}
    </div> 

    <hr style="margin-top: 20px; margin-bottom: 20px">

    <div class="textcenter">
    {% if form %}
    {{ entry("End time (hh:mm)", 'end_time', class="shorttextbox") }}
    {% else %}
    {{ entry("End time", "end_time") }}
    {% endif %}
    {{ hspace() }}
    {{ entry("Positive cycle", "positive_cycle", type="number", class="shorttextbox") }}
    </div> 

    <div class="textcenter">
    {{ entry("Total bowls", "total_bowls", type="number", class="shorttextbox") }}
    {{ hspace() }}
    {{ entry("Total cups", "total_cups", type="number", class="shorttextbox") }}
    </div> 

    <div class="textcenter">
    {{ entry("Chopsticks missing", "chopsticks_missing", type="number", class="shorttextbox") }}
    {{ hspace() }}
    {{ entry("Money off by", "money_off_by", type="number", class="shorttextbox") }}
    </div> 

    <hr style="margin-top: 20px; margin-bottom: 20px">

    <div class="textcenter">
    {{ entry("Misc notes", "misc_notes", class="longtextbox") }}
    </div> 
    <hr style="margin-top: 20px; margin-bottom: 20px">

<div id="errortext" style="color: red"></div>
{% if not form %}
{% if preview %}
<input type="submit" formaction="/createreport" formmethod="get" value="Edit" class="btn"/>
{% else %}
<a href="/createreport?date={{ report['date_string'] }}" style="text-decoration: none;">
<input type="button" class="btn" value="Edit">
</a>
{% endif %}
{% endif %}
{% if form %}
<input type="submit" class="btn" value="Preview" formaction="/previewreport" formmethod="get"/>
<input type="submit" class="btn" value="Submit" formaction="/createreport" formmethod="post"/>
{% elif preview %}
<input type="submit" class="btn" value="Submit" formaction="/createreport" formmethod="post"/>
{% else %}
{#  TODO: make deleting robust? There are a lot of issues, like updating the number of dreams
<form id="delete-form" action="/deletereport/{{ report['date_string'] }}" method="post" style="display: inline;">
<button onclick="delete_button_click()" class="btn">Delete</button>
</form>
#}
{% endif %}

</div> 
</div> 

{% if form %}
<script>
function clicked() {
   if (confirm('Are you sure you want to delete this report?')) {
       $('delete-form').submit();
   } else {
       return false;
   }
}

function validateEntry(name, regex) {
    /*
    looks for the input with `name`, and if it doesn't match the right regex,
    highlights it in red and return false
    otherwise return true
    */
    var input = $('input[name='+name+']')[0];
    if (!input) {
        console.log('no input named '+name);
        return true;
    }
    var valid = regex.test(input.value);
    if (!valid) {
        $(input).css({'border-color': 'red'});
        return false;
    } else {
        $(input).css({'border-color': ''});
        return true;
    }
}

function validateAllEntries() {
    var regexes = {
        'date': /^\d\d\d\d-\d\d-\d\d$/,

        'customers_today': /^\d+$/,
        'dreams': /^\d+$/,
        'dreamers': /^\d+$/,

        'working_members': /^.+$/,
        'supporting_members': /^.+$/,
        'visiting_members': /^.+$/,

        'end_time': /^(\d\d:\d\d)|(\d\d\d\d)$/,
        'total_bowls': /^\d+$/,
        'chopsticks_missing': /^\d+$/,
        'positive_cycle': /^\d+$/,
        'total_cups': /^\d+$/,
        'money_off_by': /^\d+$/,

        'misc_notes': /^.*$/,
    }
    var allValid = true;
    for (var name in regexes) {
        var regex = regexes[name];
        var valid = validateEntry(name, regex);
        allValid = allValid && valid;
    }
    if (allValid) {
        return true;
    } else {
        $("#errortext").html("Invalid entry. Please enter the correct information in the boxes highlighted in red, and resubmit.");
        return false;
    }
}

function prefillDate() {
    var today = new Date();
    var hours = today.getHours();
    if (hours < 13) {
        today = new Date(today.getTime() - (24 * 60 * 60 * 1000));
    }
    var dd = today.getDate();
    var mm = today.getMonth() + 1;
    var yyyy = today.getFullYear();
    if (dd < 10) {
        dd = '0'+dd;
    }
    if (mm < 10) {
        mm = '0'+mm;
    }

    var date_string = '' + yyyy + '-' + mm + '-' + dd;
    if (!$("input[name='date']").val()) {
        $("input[name='date']").val(date_string);
    }
}

$(document).ready(prefillDate);

// if we return false, the form won't be submitted
$("form").submit(validateAllEntries);
</script>
{% endif %}

{% if form %}
</form>
{% endif %}

